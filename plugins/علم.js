import { prepareWAMessageMedia, generateWAMessageFromContent } from '@whiskeysockets/baileys';

const timeout = 60000;

let handler = async (m, { conn, command }) => {
    if (command.startsWith('Ø§Ø¬Ø§Ø¨_')) {
        let id = m.chat;
        let obito = conn.obito[id];

        if (!obito) {
            return conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âš ï¸ Ù„Ø§ ØªÙ€ÙˆØ¬Ù€Ø¯ Ù„Ù€Ø¹Ù€Ø¨Ù€Ø© Ù†Ù€Ø´Ù€Ø·Ù€Ø© Ø§Ù„Ø¢Ù† â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
        }

        let selectedAnswerIndex = parseInt(command.split('_')[1]);
        if (isNaN(selectedAnswerIndex) || selectedAnswerIndex < 1 || selectedAnswerIndex > 4) {
            return conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âš ï¸ Ø§Ø®Ù€ØªÙ€ÙŠÙ€Ø§Ø± ØºÙ€ÙŠÙ€Ø± ØµÙ€Ø§Ù„Ù€Ø­ â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
        }

        let selectedAnswer = obito.options[selectedAnswerIndex - 1];
        let isCorrect = obito.correctAnswer === selectedAnswer;

        if (isCorrect) {
            await conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âœ… Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© ØµÙ€Ø­Ù€ÙŠÙ€Ø­Ù€Ø© â†*
*â†â”‡ğŸ’° Ø§Ù„Ø¬Ù€Ø§Ø¦Ù€Ø²Ø© â‡‡ã€500xpã€â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
            global.db.data.users[m.sender].exp += 500;
            clearTimeout(obito.timer);
            delete conn.obito[id];
        } else {
            obito.attempts -= 1;
            if (obito.attempts > 0) {
                await conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âŒ Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© Ø®Ù€Ø§Ø·Ù€Ø¦Ù€Ø© â†*
*â†â”‡ğŸ”„ Ù…Ù€Ø­Ù€Ø§ÙˆÙ„Ù€Ø§Øª Ù…Ù€ØªÙ€Ø¨Ù€Ù‚Ù€ÙŠÙ€Ø© â‡‡ã€${obito.attempts}ã€â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
            } else {
                await conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡â›” Ø§Ù†Ù€ØªÙ€Ù‡Ù€Øª Ù…Ù€Ø­Ù€Ø§ÙˆÙ„Ù€Ø§ØªÙ€Ùƒ â†*
*â†â”‡âœ… Ø§Ù„Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© Ø§Ù„Ù€ØµÙ€Ø­Ù€ÙŠÙ€Ø­Ù€Ø© â‡‡ã€${obito.correctAnswer}ã€â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
                clearTimeout(obito.timer);
                delete conn.obito[id];
            }
        }
    } else {
        try {
            conn.obito = conn.obito || {};
            let id = m.chat;

            if (conn.obito[id]) {
                return conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âš ï¸ Ù„Ù€Ø¯ÙŠÙ€Ùƒ Ù„Ù€Ø¹Ù€Ø¨Ù€Ø© Ù‚Ù€ÙŠÙ€Ø¯ Ø§Ù„Ù€ØªÙ€Ø´Ù€ØºÙ€ÙŠÙ€Ù„ â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
            }

            const response = await fetch('https://raw.githubusercontent.com/ze819/game/master/src/game.js/luffy1.json');
            const obitoData = await response.json();

            const obitoItem = obitoData[Math.floor(Math.random() * obitoData.length)];
            const { img, name } = obitoItem;

            let options = [name];
            while (options.length < 4) {
                let randomItem = obitoData[Math.floor(Math.random() * obitoData.length)].name;
                if (!options.includes(randomItem)) options.push(randomItem);
            }
            options.sort(() => Math.random() - 0.5);

            const media = await prepareWAMessageMedia({ image: { url: img } }, { upload: conn.waUploadToServer });

            const interactiveMessage = {
                body: {
                    text: `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡ğŸš© Ù„Ù€Ø¹Ù€Ø¨Ù€Ø© "Ø§Ø¹Ù€Ø±Ù Ø¹Ù€Ù„Ù€Ù… Ø§Ù„Ù€Ø¯Ù„Ù€Ø©" â†*
*â†â”‡â³ Ø§Ù„Ù€ÙˆÙ‚Ù€Øª â‡‡ã€60 Ø«Ø§Ù†Ù€ÙŠÙ€Ø©ã€â†*
*â†â”‡ğŸ’° Ø§Ù„Ø¬Ù€Ø§Ø¦Ù€Ø²Ø© â‡‡ã€500xpã€â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
                    `.trim(),
                },
                footer: { text: 'á–‡Yá˜”O á—·OT' },
                header: {
                    title: 'ã…¤',
                    subtitle: 'Ø§Ø®Ù€ØªÙ€Ø± Ø§Ù„Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© Ø§Ù„Ù€ØµÙ€Ø­Ù€ÙŠÙ€Ø­Ù€Ø© Ù…Ù€Ù† Ø§Ù„Ø£Ø³Ù€ÙÙ€Ù„ âœ…',
                    hasMediaAttachment: true,
                    imageMessage: media.imageMessage,
                },
                nativeFlowMessage: {
                    buttons: options.map((option, index) => ({
                        name: 'quick_reply',
                        buttonParamsJson: JSON.stringify({
                            display_text: `âŒ–${index + 1}âŒ–â‡‡ã€${option}ã€`,
                            id: `.Ø§Ø¬Ø§Ø¨_${index + 1}`
                        })
                    })),
                },
            };

            let msg = generateWAMessageFromContent(m.chat, {
                viewOnceMessage: {
                    message: { interactiveMessage },
                },
            }, { userJid: conn.user.jid, quoted: m });

            conn.relayMessage(m.chat, msg.message, { messageId: msg.key.id });

            conn.obito[id] = {
                correctAnswer: name,
                options,
                attempts: 2,
                timer: setTimeout(async () => {
                    if (conn.obito[id]) {
                        await conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡â›” Ø§Ù†Ù€ØªÙ€Ù‡Ù€Ù‰ Ø§Ù„Ù€ÙˆÙ‚Ù€Øª â†*
*â†â”‡âœ… Ø§Ù„Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© Ø§Ù„Ù€ØµÙ€Ø­Ù€ÙŠÙ€Ø­Ù€Ø© â‡‡ã€${name}ã€â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
                        `.trim(), m);
                        delete conn.obito[id];
                    }
                }, timeout)
            };

        } catch (e) {
            console.error(e);
            conn.reply(m.chat, `
*â•­â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
*â†â”‡âš ï¸ Ø­Ù€Ø¯Ø« Ø®Ù€Ø·Ù€Ø£ ÙÙ€ÙŠ Ø¥Ø±Ù€Ø³Ù€Ø§Ù„ Ø§Ù„Ù€Ø±Ø³Ù€Ø§Ù„Ù€Ø© â†*
*â•°â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâŸ*
`, m);
        }
    }
};

handler.help = ['Ø¹Ù„Ù…'];
handler.tags = ['game'];
handler.command = /^(Ø¹Ù„Ù…|Ø§Ø¹Ù„Ø§Ù…|Ø§Ø¬Ø§Ø¨_\d+)$/i;

export default handler;